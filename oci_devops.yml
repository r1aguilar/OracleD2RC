version: 0.1
component: build
timeoutInSeconds: 1800        # 30 min – raise if native-image is slow
shell: bash

###############################################################################
# 1. Environment
###############################################################################
env:
  variables:
    # GraalVM EE for Java 17 (kept from your spec)
    JAVA_HOME: /usr/lib64/graalvm/graalvm22-ee-java17

    # OCIR coordinates – leave the repo name as a PIPELINE PARAMETER so it
    # can be reused by Dev / Staging / Prod.  Edit the default values in the
    # pipeline UI (see step 9).
    OCIR_REGION: mx-queretaro-1
    OCIR_REPO: ${CONTAINER_REPO_PATH}     # ⇒  axgw2tdpave8/mtdrspring

  exportedVariables:
    # Sent to subsequent stages (Deliver Artifacts / Deploy):
    - BuildServiceDemoVersion    # short Git SHA
    - FULL_IMAGE_NAME            # repo:tag that was pushed

###############################################################################
# 2. Steps
###############################################################################
steps:
  # --------------------------------------------------------------------------
  - type: Command
    name: "Install build dependencies"
    timeoutInSeconds: 600
    command: |
      yum -y install graalvm22-ee-17-native-image docker git maven jq
      systemctl start docker

  - type: Command
    name: "Add GraalVM to PATH"
    command: |
      export PATH=$JAVA_HOME/bin:$PATH

  # --------------------------------------------------------------------------
  - type: Command
    name: "Derive build version (short commit hash)"
    command: |
      BuildServiceDemoVersion=$(git rev-parse --short HEAD)
      echo "BuildServiceDemoVersion=$BuildServiceDemoVersion" >> "$OCI_EXPORTS_FILE"

  # --------------------------------------------------------------------------
  - type: Command
    name: "Login to OCIR with temp creds from Object Storage"
    command: |
      cd MtdrSpring
      oci os object get --bucket-name reacttodo-rolax \
                        --name deployment_config.tgz \
                        --file deployment_config.tgz
      tar -xzvf deployment_config.tgz
      source env.sh                      # populates at.cfg
      cat at.cfg | docker login -u "axgw2tdpave8/a01285921@tec.mx" \
                               --password-stdin ${OCIR_REGION}.ocir.io

  # --------------------------------------------------------------------------
  - type: Command
    name: "Build Java, build Docker image, push to OCIR"
    command: |
      cd MtdrSpring/backend
      chmod +x build.sh
      ./build.sh                          # compiles jar / native image
      IMAGE_TAG="$BuildServiceDemoVersion"
      docker build -t ${OCIR_REGION}.ocir.io/${OCIR_REPO}:${IMAGE_TAG} .
      docker push    ${OCIR_REGION}.ocir.io/${OCIR_REPO}:${IMAGE_TAG}
      echo "FULL_IMAGE_NAME=${OCIR_REGION}.ocir.io/${OCIR_REPO}:${IMAGE_TAG}" \
           >> "$OCI_EXPORTS_FILE"

  # --------------------------------------------------------------------------
  - type: Command
    name: "Selenium headless UI tests"
    command: |
      cd MtdrSpring/tests/selenium
      mvn -B test                             # JUnit XML results land in ./target

  # --------------------------------------------------------------------------
  - type: Command
    name: "JMeter load tests"
    command: |
      cd MtdrSpring/tests/jmeter
      jmeter -n -t load_test.jmx -l results.jtl

  # --------------------------------------------------------------------------
  - type: Command
    name: "OWASP ZAP baseline scan"
    command: |
      zap-baseline.py -t "https://your-dev-endpoint.com" \
                      -J zap_report.json     \
                      -r zap_report.html

###############################################################################
# 3. Output artifact (container image)
###############################################################################
outputArtifacts:
  - name: containerImage
    type: DOCKER_IMAGE
    location: ${FULL_IMAGE_NAME}            # ← required syntax :contentReference[oaicite:0]{index=0}
