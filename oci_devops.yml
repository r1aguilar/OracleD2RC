version: 0.1
component: build
timeoutInSeconds: 600
shell: bash

env:
  variables:
    JAVA_HOME: /usr/lib64/graalvm/graalvm22-ee-java17
  exportedVariables:
    - BuildServiceDemoVersion

steps:
  # --------------------------------------------------------------------------
  - type: Command
    name: "Install GraalVM Enterprise 22.x Native Image for Java17"
    runAs: root
    command: |
      yum -y install graalvm22-ee-17-native-image

  - type: Command
    name: "Set PATH Variable"
    command: |
      export PATH=$JAVA_HOME/bin:$PATH

  # --------------------------------------------------------------------------
  - type: Command
    name: "Docker Login (credenciales axgw2tdpave8)"
    command: |
      cd MtdrSpring
      oci os object get \
        --bucket-name reacttodo-rolax \
        --name deployment_config.tgz \
        --file deployment_config.tgz
      tar -xzvf deployment_config.tgz
      source env.sh
      docker login \
        -u "axgw2tdpave8/a01285921@tec.mx" \
        -p "e6k)8n.:E6y[#L{5()jm" \
        mx-queretaro-1.ocir.io || exit 1

  # --------------------------------------------------------------------------
  - type: Command
    name: "Build"
    failImmediatelyOnError: true
    command: |
      cd MtdrSpring
      source env.sh
      (cd backend && source build.sh)

  # --------------------------------------------------------------------------
  - type: Command
    name: "Install K8s"
    command: |
      mkdir -p $HOME/k8s $HOME/.kube
      curl -L -o $HOME/k8s/kubectl https://dl.k8s.io/v1.31.2/bin/linux/amd64/kubectl
      chmod +x $HOME/k8s/kubectl
      export PATH=$PATH:$HOME/k8s
      kubectl version --client

      oci ce cluster create-kubeconfig \
        --cluster-id ocid1.cluster.oc1.mx-queretaro-1.aaaaaaaasajbmfcpyzvx6rmvk6rf5mumkqc7tdilav7gtd57ac73xtlczuyq \
        --file $HOME/.kube/config \
        --region mx-queretaro-1 \
        --token-version 2.0.0 \
        --kube-endpoint PUBLIC_ENDPOINT
      export KUBECONFIG=$HOME/.kube/config

  # --------------------------------------------------------------------------
  - type: Command
    name: "Undeploy"
    command: |
      export PATH=$PATH:$HOME/k8s
      export KUBECONFIG=$HOME/.kube/config
      cd MtdrSpring/backend
      source ../env.sh
      kubectl config view
      source undeploy.sh
